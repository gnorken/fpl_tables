{% extends "info_club.html" %}
{% set hide_element = True %}

{% block title %}By Teams{% endblock %}

{% block page_content %}
<div class="col-12">
    <div class="table-responsive table-scroll-viewport sticky-2rows">
        <table id="teams-table" class="interactive-table table table-borderless table-striped text-center text-nowrap">
            <thead class="th-bg-primary text-center">
                <tr>
                    <th id="top-players" class="sticky-col align-middle round-border-lg-top">↑ Top Five
                    </th>
                    <th colspan="18" class="bg-team round-border-lg-top"
                        title="Players that are or have been in {{ manager.team_name }} this season">
                        Stats for {{ manager.team_name }}
                    </th>
                    <th colspan="13" class="round-border-lg-top">Team Totals</th>
                </tr>
                <tr>
                    <th id="entries" class="sticky-col"></th>
    
                    {# — 18 primary cols (per-team) — #}
                    <th data-sort="starts_team" class="sort-team bg-team">S</th>
                    <th data-sort="minutes_team" class="sort-team bg-team">Min</th>
                    <th data-sort="clean_sheets_team" class="sort-team bg-team">CS</th>
                    <th data-sort="assists_team" class="sort-team bg-team">A</th>
                    <th data-sort="expected_assists_team" class="sort-team bg-team">xA</th>
                    <th data-sort="goals_scored_team" class="sort-team bg-team">G</th>
                    <th data-sort="expected_goals_team" class="sort-team bg-team">xG</th>
                    <th data-sort="captained_team" class="sort-team bg-team">C</th>
                    <th data-sort="dreamteam_count_team" class="sort-team bg-team">DT</th>
                    <th data-sort="bonus_team" class="sort-team bg-team">B</th>
                    <th data-sort="penalties_saved_team" class="sort-team bg-team">PS</th>
                    <th data-sort="starts_benched_team" class="sort-team bg-team">bS</th>
                    <th data-sort="minutes_benched_team" class="sort-team bg-team">bM</th>
                    <th data-sort="yellow_cards_team" class="sort-team bg-team">YC</th>
                    <th data-sort="red_cards_team" class="sort-team bg-team">RC</th>
                    <th data-sort="goals_conceded_team" class="sort-team bg-team">GC</th>
                    <th data-sort="own_goals_team" class="sort-team bg-team">OG</th>
                    <th data-sort="penalties_missed_team" class="sort-team bg-team">PM</th>
    
                    {# — 13 secondary overall cols — #}
                    <th data-sort="clean_sheets" class="sort">CS</th>
                    <th data-sort="assists" class="sort">A</th>
                    <th data-sort="expected_assists" class="sort">xA</th>
                    <th data-sort="goals_scored" class="sort">G</th>
                    <th data-sort="expected_goals" class="sort">xG</th>
                    <th data-sort="dreamteam_count" class="sort">DT</th>
                    <th data-sort="bonus" class="sort">B</th>
                    <th data-sort="penalties_saved" class="sort">PS</th>
                    <th data-sort="yellow_cards" class="sort">YC</th>
                    <th data-sort="red_cards" class="sort">RC</th>
                    <th data-sort="goals_conceded" class="sort">GC</th>
                    <th data-sort="own_goals" class="sort">OG</th>
                    <th data-sort="penalties_missed" class="sort">PM</th>
                </tr>
            </thead>
    
            <tbody id="teams-table-body"></tbody>
    
            <tfoot>
                <tr class="th-bg-primary text-center">
                    <th class="sticky-col round-border-lg-btm"></th>
                    <th colspan="18" class="bg-team round-border-lg-btm">
                        <div id="loading" style="display:none;">Loading…</div>
                    </th>
                    <th colspan="13" class="round-border-lg-btm"></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1) header‐hover lookup:
    const managerName = {{ manager.team_name| tojson }};
    const lookup = {
        "starts_team": `Starts for ${managerName}`,
        "minutes_team": `Minutes for ${managerName}`,
        "clean_sheets_team": `Clean sheets for ${managerName}`,
        "assists_team": `Assists for ${managerName}`,
        "expected_assists_team": `Expected assists for ${managerName}`,
        "goals_scored_team": `Goals for ${managerName}`,
        "expected_goals_team": `Expected goals for ${managerName}`,
        "captained_team": `Times captained for ${managerName}`,
        "dreamteam_count_team": `DreamTeam entries for ${managerName}`,
        "bonus_team": `Bonus points for ${managerName}`,
        "penalties_saved_team": `Penalties saved for ${managerName}`,
        "starts_benched_team": `Benched starts for ${managerName}`,
        "minutes_benched_team": `Benched minutes for ${managerName}`,
        "yellow_cards_team": `Yellow cards for ${managerName}`,
        "red_cards_team": `Red cards for ${managerName}`,
        "goals_conceded_team": `Conceded goals for ${managerName}`,
        "own_goals_team": `Own goals by ${managerName}`,
        "penalties_missed_team": `Penalties missed by ${managerName}`,

        "clean_sheets": "Total clean sheets. *Cumulative all players",
        "assists": "Total assists",
        "expected_assists": "Total expected assists",
        "goals_scored": "Total goals scored",
        "expected_goals": "Total expected goals",
        "dreamteam_count": "Total dreamteam entries",
        "bonus": "Total bonus points",
        "penalties_saved": "Total penalties saved",
        "yellow_cards": "Total yellow cards",
        "red_cards": "Total red cards",
        "goals_conceded": "Total conceded goals",
        "own_goals": "Total own goals",
        "penalties_missed": "Total penalties missed",

        "top-players": "Pictures of top players",
        "entries": "Number of entries",
        "team-data": "Team stats",
        "overall-data": "Overall stats"
    };

    // 2) pageConfig for script.js
    window.tableConfig = {
        table: "teams",
        url: `/get-sorted-players?table=teams&team_id={{ team_id }}`,
        tbodySelector: "#teams-table-body",
        loadingSelector: "#loading",
        currentGw: {{ (current_gw or 1)| int }},
        sortBy: "{{ sort_by }}",
        sortOrder: "{{ order }}",
        lookup: lookup,
        columns: [
            // name/rank
            {
                render: (p, idx) => {
                    const badgeUrl = `https://resources.premierleague.com/premierleague/badges/100/t${p.team_code}@x2.png`;
                return`
                <td class="sticky-col vert-border">
                    <div class="d-flex align-items-center">
                        <img
                        src="${badgeUrl}"
                        alt="${p.team_name} badge"
                        class="img-fluid overlap-badge ms-1 badge-20"
                        data-bs-toggle="tooltip"
                        title="${p.team_name}"
                        >
                        <div class="d-flex">
                        <div style="width:3ch">${idx + 1}</div>
                        <div>${p.team_name}</div>
                        </div>
                    </div>
                </td>`
              }
            },

            // 18 primary
            { key: "starts_team", className: "sort-team vert-border-secondary", sortLevel: "primary", dataColumn: "starts" },
            { key: "minutes_team", className: "sort-team", sortLevel: "primary", dataColumn: "minutes" },
            { key: "clean_sheets_team", className: "sort-team", dataColumn: "clean_sheets", sortLevel: "primary", dataColumn: "clean_sheets" },
            { key: "assists_team", className: "sort-team", sortLevel: "primary", dataColumn: "assists" },
            { key: "expected_assists_team", className: "sort-team", sortLevel: "primary", dataColumn: "expected_assists", formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: "goals_scored_team", className: "sort-team", sortLevel: "primary", dataColumn: "goals_scored" },
            { key: "expected_goals_team", className: "sort-team", sortLevel: "primary", dataColumn: "expected_goals", formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: "captained_team", className: "sort-team", sortLevel: "primary", dataColumn: "captained" },
            { key: "dreamteam_count_team", className: "sort-team", sortLevel: "primary", dataColumn: "dreamteam_count" },
            { key: "bonus_team", className: "sort-team", sortLevel: "primary", dataColumn: "bonus" },
            { key: "penalties_saved_team", className: "sort-team", sortLevel: "primary", dataColumn: "penalties_saved" },
            { key: "starts_benched_team", className: "sort-team vert-border", sortLevel: "primary", dataColumn: "starts_benched" },
            { key: "minutes_benched_team", className: "sort-team vert-border-end", sortLevel: "primary", dataColumn: "minutes_benched" },
            { key: "yellow_cards_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "yellow_cards" },
            { key: "red_cards_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "red_cards" },
            { key: "goals_conceded_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "goals_conceded" },
            { key: "own_goals_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "own_goals" },
            { key: "penalties_missed_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "penalties_missed" },

            // 13 secondary
            { key: "clean_sheets", className: "sort vert-border-secondary", sortLevel: "secondary", dataColumn: "clean_sheets" },
            { key: "assists", className: "sort", sortLevel: "secondary", dataColumn: "assists" },
            { key: "expected_assists", className: "sort", sortLevel: "secondary", dataColumn: "expected_assists", formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: "goals_scored", className: "sort", sortLevel: "secondary", dataColumn: "goals_scored" },
            { key: "expected_goals", className: "sort", sortLevel: "secondary", dataColumn: "expected_goals", formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: "dreamteam_count", className: "sort", sortLevel: "secondary", dataColumn: "dreamteam_count" },
            { key: "bonus", className: "sort", sortLevel: "secondary", dataColumn: "bonus" },
            { key: "penalties_saved", className: "sort", sortLevel: "secondary", dataColumn: "penalties_saved" },
            { key: "yellow_cards", className: "sort text-danger vert-border", sortLevel: "secondary", dataColumn: "yellow_cards" },
            { key: "red_cards", className: "sort text-danger", sortLevel: "secondary", dataColumn: "red_cards" },
            { key: "goals_conceded", className: "sort text-danger", sortLevel: "secondary", dataColumn: "goals_conceded" },
            { key: "own_goals", className: "sort text-danger", sortLevel: "secondary", dataColumn: "own_goals" },
            { key: "penalties_missed", className: "sort text-danger vert-border-end", sortLevel: "secondary", dataColumn: "penalties_missed" }
        ]
    };


    (() => {
        const wraps = document.querySelectorAll('.table-scroll-viewport.sticky-2rows');
        wraps.forEach(wrap => {
            const row1 = wrap.querySelector('thead tr:first-child');
            if (!row1) return;
            const setTop = () => wrap.style.setProperty('--th-row1-h', (row1.getBoundingClientRect().height || 0) + 'px');
            setTop();
            addEventListener('resize', setTop, { passive: true });
            if ('ResizeObserver' in window) new ResizeObserver(setTop).observe(row1);
        });
    })();
</script>


{% endblock %}