{% extends "info.html" %}
{% block title %}By Points{% endblock %}

{% block page_content %}
<div class="table-responsive">
    <table id="points-table" class="interactive-table table table-borderless table-striped text-center text-nowrap">
        <thead class="th-bg-primary text-center">
            <tr>
                <th id="top-players" data-sort="top-players" class="sticky-col align-middle round-border-top-left">↑ Top Five
                </th>
                <th colspan="2" class="round-border-top-right"></th>
                <th colspan="18" data-sort="team-data" class="bg-team round-border-top"
                    title="Players that are or have been in {{ manager.team_name }} this season">
                    Stats for {{ manager.team_name }}
                </th>
                <th colspan="16" data-sort="overall-data" class="round-border-top">Player Totals</th>
            </tr>
            <tr>
                <th id="entries" data-sort="entries" class="sticky-col"></th>
                <th data-sort="selected_by_percent" class="sort">%</th>
                <th data-sort="now_cost" class="sort">£</th>

                {# — 16 team-specific (primary) columns — #}
                <th data-sort="total_points_team" class="sort-team bg-team">P</th>
                <th data-sort="captain_points_team" class="sort-team bg-team">C</th>
                <th data-sort="benched_points_team" class="sort-team bg-team">B</th>
                <th data-sort="points_per_game_team" class="sort-team bg-team">PPG</th>
                <th data-sort="ppm_team" class="sort-team bg-team">PPM</th>
                <th data-sort="minutes_points_team" class="sort-team bg-team">M</th>
                <th data-sort="defensive_contribution_points_team" class="sort-team bg-team">DC</th>
                <th data-sort="clean_sheets_points_team" class="sort-team bg-team">CS</th>
                <th data-sort="assists_points_team" class="sort-team bg-team">A</th>
                <th data-sort="goals_scored_points_team" class="sort-team bg-team">G</th>
                <th data-sort="bonus_team" class="sort-team bg-team">B</th>
                <th data-sort="save_points_team" class="sort-team bg-team">S</th>
                <th data-sort="penalties_saved_points_team" class="sort-team bg-team">PS</th>
                <th data-sort="goals_conceded_points_team" class="sort-team bg-team">GC</th>
                <th data-sort="yellow_cards_points_team" class="sort-team bg-team">YC</th>
                <th data-sort="red_cards_points_team" class="sort-team bg-team">RC</th>
                <th data-sort="own_goals_points_team" class="sort-team bg-team">OG</th>
                <th data-sort="penalties_missed_points_team" class="sort-team bg-team">PM</th>

                {# — 14 overall (secondary) columns — #}
                <th data-sort="total_points" class="sort">P</th>
                <th data-sort="points_per_game" class="sort">PPG</th>
                <th data-sort="ppm" class="sort">PPM</th>
                <th data-sort="minutes_points" class="sort">M</th>
                <th data-sort="defensive_contribution_points" class="sort">DC</th>
                <th data-sort="clean_sheets_points" class="sort">CS</th>
                <th data-sort="assists_points" class="sort">A</th>
                <th data-sort="goals_scored_points" class="sort">G</th>
                <th data-sort="bonus" class="sort">B</th>
                <th data-sort="saves_points" class="sort">S</th>
                <th data-sort="penalties_saved_points" class="sort">PS</th>
                <th data-sort="goals_conceded_points" class="sort">GC</th>
                <th data-sort="yellow_cards_points" class="sort">YC</th>
                <th data-sort="red_cards_points" class="sort">RC</th>
                <th data-sort="own_goals_points" class="sort">OG</th>
                <th data-sort="penalties_missed_points" class="sort">PM</th>
            </tr>
        </thead>

        <tbody id="player-table-body">
            <!-- injected by script.js -->
        </tbody>

        <tfoot>
            <tr class="th-bg-primary text-center">
                <th class="sticky-col round-border-btm-left"></th>
                <th colspan="2" class="th-bg-primary round-border-btm-right"></th>
                <th colspan="18" class="bg-team round-border-btm">
                    <div id="loading" style="display:none;">Loading…</div>
                </th>
                <th colspan="16" class="round-border-btm"></th>
            </tr>
        </tfoot>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1) Build a lookup for header-hover tooltips
    const managerName = {{ manager.team_name| tojson }};
    const lookup = {
        "selected_by_percent": "Teams selected by",
        "now_cost": "Current price",

        "total_points_team": `Points for ${managerName}`,
        "ppm_team": `Points per million for ${managerName}`,
        "points_per_game_team": `Points per game for ${managerName}`,
        "minutes_points_team": `Points for minutes played by ${managerName}`,
        "defensive_contribution_points_team": `Points for defensive contributions by ${managerName}`,
        "clean_sheets_points_team": `Points for clean sheets by ${managerName}`,
        "assists_points_team": `Points for assists by ${managerName}`,
        "goals_scored_points_team": `Points for goals by ${managerName}`,
        "bonus_team": `Bonus points for ${managerName}`,
        "save_points_team": `Points for saves by ${managerName}`,
        "penalties_saved_points_team": `Points for penalties saved for ${managerName}`,
        "goals_conceded_points_team": `Points lost to conceded goals for ${managerName}`,
        "yellow_cards_points_team": `Points deducted for yellow cards for ${managerName}`,
        "red_cards_points_team": `Points lost to red cards by ${managerName}`,
        "own_goals_points_team": `Points lost to own goals by ${managerName}`,
        "penalties_missed_points_team": `Points lost to missed penalties by ${managerName}`,
        "benched_points_team": `Points while benched for ${managerName}`,
        "captain_points_team": `Points when captained by ${managerName}`,

        "total_points": "Total points",
        "points_per_game": "Total points per game average",
        "ppm": "Total points-per-million",
        "minutes_points": "Total points for minutes playeds",
        "defensive_contribution_points": "Total points for defensive contributions",
        "clean_sheets_points": "Total points for clean sheets",
        "assists_points": "Total points for assist",
        "goals_scored_points": "Total points for goal scored",
        "bonus": "Total bonus points",
        "saves_points": "Total points for saves",
        "penalties_saved_points": "Total points for penalties saved",
        "goals_conceded_points": "Total minus points for conceded goals",
        "yellow_cards_points": "Total minus points for yellow cards",
        "red_cards_points": "Total minus points for red cards",
        "own_goals_points": "Total minus points for own goals",
        "penalties_missed_points": "Total minus points for missed penalties",

        "top-players": "Pictures of the top players for this category",
        "entries": "Number of entries",
        "team-data": "Team stats",
        "overall-data": "Overall stats"
    };

    const positionMap = {
            1: "GK",
            2: "DEF",
            3: "MID",
            4: "FWD"
        };

    // 2) Configure the shared script:
    window.tableConfig = {
        table: "points",
        url: `/get-sorted-players?table=points&team_id={{ team_id }}`,
        tbodySelector: "#player-table-body",
        loadingSelector: "#loading",
        currentGw: {{ (current_gw or 1)| int }},
        sortBy: "{{ sort_by }}",
        sortOrder: "{{ order }}",
        lookup: lookup,
        columns: [
            // rank + name
            { render: (p, idx) => {
                const short = p.web_name.length > 11 ? p.web_name.slice(0, 13) + '…' : p.web_name;
                const badgeUrl = `https://resources.premierleague.com/premierleague/badges/100/t${p.team_code}@x2.png`;

                return `
                    <td class="sticky-col vert-border-end vert-border">
                        <div class="d-flex align-items-center">
                            <div class="text-center" style="width:2ch; flex:0 0 auto;">${idx + 1}</div>
                            <img 
                                src="${badgeUrl}"
                                alt="${p.team_name} badge"
                                class="img-fluid overlap-badge ms-1"
                                data-bs-toggle="tooltip"
                                title="${p.team_name}"
                                style="width: 20px; height: 20px; flex:0 0 auto;"
                                onerror="this.onerror=null;this.src='https://resources.premierleague.com/premierleague/photos/players/110x140/Photo-Missing.png';"
                            >
                            <div class="d-flex align-items-end ">
                                <div class="ms-1 text-truncate">${short}</div>
                                <div class="small text-muted d-none d-lg-inline">&nbsp;${positionMap[p.element_type] || p.element_type}</div>
                            </div>
                        </div>
                    </td>`;
                }
            },

            { key: "selected_by_percent", className: "sort", dataColumn: "selected_by_percent", formatter: v => `${parseFloat(v).toFixed(0)}%` },
            { key: "now_cost", className: "sort", dataColumn: "now_cost", formatter: v => `£${(v / 10).toFixed(1)}m` },

            // 16 primary columns
            { key: "total_points_team", className: "sort-team vert-border", sortLevel: "primary", dataColumn: "total_points" },
            { key: "captain_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "captained_points" },
            { key: "benched_points_team", className: "sort-team text-primary", sortLevel: "primary", dataColumn: "benched_points" },
            { key: "points_per_game_team", className: "sort-team", sortLevel: "primary", dataColumn: "points_per_game", formatter: v => `${parseFloat(v).toFixed(1)}`  },
            { key: "ppm_team", className: "sort-team", sortLevel: "primary", dataColumn: "ppm" },
            { key: "minutes_points_team", className: "sort-team vert-border", sortLevel: "primary", dataColumn: "minutes_points" },
            { key: "defensive_contribution_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "defcon_points" },
            { key: "clean_sheets_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "clean_sheets_points" },
            { key: "assists_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "assists_points" },
            { key: "goals_scored_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "goals_scored_points" },
            { key: "bonus_team", className: "sort-team", sortLevel: "primary", dataColumn: "bonus" },
            { key: "saves_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "save_points" },
            { key: "penalties_saved_points_team", className: "sort-team", sortLevel: "primary", dataColumn: "penalties_saved_points" },
            { key: "goals_conceded_points_team", className: "sort-team text-danger vert-border", sortLevel: "primary", dataColumn: "goals_conceded_points" },
            { key: "yellow_cards_points_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "yellow_cards_points" },
            { key: "red_cards_points_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "red_cards_points" },
            { key: "own_goals_points_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "own_goals_points" },
            { key: "penalties_missed_points_team", className: "sort-team text-danger", sortLevel: "primary", dataColumn: "penalties_missed_points" },

            // 14 secondary columns
            { key: "total_points", className: "sort vert-border", sortLevel: "secondary", dataColumn: "total_points" },
            { key: "points_per_game", className: "sort", sortLevel: "secondary", dataColumn: "points_per_game" },
            { key: "ppm", className: "sort", sortLevel: "secondary", dataColumn: "ppm" },
            { key: "minutes_points", className: "sort vert-border", sortLevel: "secondary", dataColumn: "minutes_points" },
            { key: "defensive_contribution_points", className: "sort", sortLevel: "secondary", dataColumn: "defcon_points" },
            { key: "clean_sheets_points", className: "sort", sortLevel: "secondary", dataColumn: "clean_sheets_points" },
            { key: "assists_points", className: "sort", sortLevel: "secondary", dataColumn: "assists_points" },
            { key: "goals_scored_points", className: "sort", sortLevel: "secondary", dataColumn: "goals_scored_points" },
            { key: "bonus", className: "sort", sortLevel: "secondary", dataColumn: "bonus" },
            { key: "saves_points", className: "sort", sortLevel: "secondary", dataColumn: "save_points" },
            { key: "penalties_saved_points", className: "sort", sortLevel: "secondary", dataColumn: "penalties_saved_points" },
            { key: "goals_conceded_points", className: "sort text-danger vert-border", sortLevel: "secondary", dataColumn: "goals_conceded_points" },
            { key: "yellow_cards_points", className: "sort text-danger", sortLevel: "secondary", dataColumn: "yellow_cards_points" },
            { key: "red_cards_points", className: "sort text-danger", sortLevel: "secondary", dataColumn: "red_cards_points" },
            { key: "own_goals_points", className: "sort text-danger", sortLevel: "secondary", dataColumn: "own_goals_points" },
            { key: "penalties_missed_points", className: "sort text-danger vert-border-end", sortLevel: "secondary", dataColumn: "penalties_missed_points" }
        ]
    };
</script>

{% endblock %}