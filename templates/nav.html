{# ===== Helpers & safe guards (top of file) ===== #}
{% set has_manager = manager is defined and manager %}
{% set has_team = team_id is defined and team_id %}

{# Compact counts with K/M, dash for unknown #}
{% macro fmt_count_compact(n) -%}
{%- if n is number and n >= 1000000 -%}
{{ (n / 1000000)|round(1) }}M
{%- elif n is number and n >= 100000 -%}
{{ ((n + 500) // 1000)|int }}K
{%- elif n is number and n >= 1000 -%}
{{ n|thousands }}
{%- elif n is number and n > 0 -%}
{{ n }}
{%- else -%}
‚Äî
{%- endif -%}
{%- endmacro %}

{# Rank: ordinal for small numbers; compact (no ordinal) for big #}
{% macro fmt_rank_compact(r) -%}
{%- if r is number and r > 0 -%}
{%- if r >= 1000000 -%}
{{ (r / 1000000)|round(1) }}M
{%- elif r >= 100000 -%}
{{ ((r + 500) // 1000)|int }}K
{%- else -%}
{{ r|ordinalformat }}
{%- endif -%}
{%- else -%}
‚Äî
{%- endif -%}
{%- endmacro %}

<header class="bg-primary text-light p-2">
    <nav class="d-flex align-items-center">
        <!-- LOGO + GW -->
        <div id="header-logo-gw" class="{{ '' if request.endpoint == 'index' else 'd-none d-md-block' }} me-2">
            <a href="/" class="d-flex align-items-end text-light text-decoration-none p-2">
                <h1 id="header-logo" class="m-0 h6 fw-bold">FPL Tables</h1>
                <span id="header-gw" class="d-none d-sm-block px-2 text-center fw-lighter" aria-live="polite">
                    {% if is_updating %}
                    Updating
                    {% elif current_gw is none %}
                    Preseason
                    {% else %}
                    GW{{ current_gw }}{% if is_live %} <span class="live-indicator" title="Matches live">LIVE
                        üî¥</span>{% endif %}
                    {% endif %}
                </span>
            </a>
        </div>

        {# MANAGER BADGE + NAMES (only if we have a manager) #}
        {% if has_manager %}
        <div id="flag" class="me-2">
            {% if manager.national_league_url %}
            <a href="{{ manager.national_league_url }}">{{ manager.flag_html|safe }}</a>
            {% else %}
            {{ manager.flag_html|safe }}
            {% endif %}
        </div>
        <a href="{{ url_for('manager', team_id=team_id) }}">
            <div id="header-team-name" class="d-flex flex-column">
                <h2 class="mb-0">{{ manager.first_name }} {{ manager.last_name }}'s&nbsp;</h2>
                <h2 class="mb-0">{{ manager.team_name }}</h2>
            </div>
        </a>
        {% endif %}

        <!-- THE DROPDOWN BUTTON -->
        <div class="dropdown ms-auto">
            <button id="tables-btn" class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                Menu
            </button>

            <ul class="dropdown-menu" aria-labelledby="tables-btn">
                {# Link macro (disabled if no team) #}
                {% macro nav_item(label, endpoint, page_name, require_team=True) -%}
                <li>
                    {% if require_team and not has_team %}
                    <a class="dropdown-item disabled">{{ label }}</a>
                    {% else %}
                    <a class="dropdown-item{% if current_page == page_name %} active{% endif %}"
                        href="{{ url_for(endpoint, team_id=team_id) if require_team else url_for(endpoint) }}">
                        {{ label }}
                    </a>
                    {% endif %}
                </li>
                {%- endmacro %}

                <li>
                    {% if has_manager %}
                    <a class="dropdown-item{% if current_page == 'manager' %} active{% endif %}"
                        href="{{ url_for('manager', team_id=team_id) }}">
                        {{ manager.team_name }} Team History
                    </a>
                    {% else %}
                    <a class="dropdown-item disabled">No manager ID</a>
                    {% endif %}
                </li>

                <li>
                    <hr class="dropdown-divider">
                </li>

                <li>
                    <h6 class="dropdown-header">
                        {% if has_manager %}{{ manager.team_name }} tables{% else %}Please enter ID for custom tables{% endif %}
                    </h6>
                </li>
                {% if has_manager %}
                    {{ nav_item('Summary', 'summary', 'summary') }}
                    {{ nav_item('Defence', 'defence', 'defence') }}
                    {{ nav_item('Offence', 'offence', 'offence') }}
                    {{ nav_item('By Points', 'points', 'points') }}
                    {{ nav_item('By Teams', 'teams', 'teams') }}
                {% endif %}
                <li>
                    <hr class="dropdown-divider">
                </li>

                <li>
                    <h6 class="dropdown-header">General tables</h6>
                </li>
                {{ nav_item('Talisman', 'talisman', 'talisman', require_team=False) }}
                {{ nav_item('Players', 'players', 'players', require_team=False) }}
                {% if has_manager %}
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="/">Enter New ID</a></li>
                {% endif %}

                <li>
                    <hr class="dropdown-divider">
                </li>

                {% if has_manager %}
                <li>
                    <h6 class="dropdown-header">My Mini-Leagues</h6>
                </li> 
                {% else %}
                <li>
                    <h6 class="dropdown-header">Please enter team ID for mini-leagues</h6>
                </li>
                {% endif %}
                {# MINI-LEAGUES (render only when we have manager; keeps dropdown intact on "/") #}
                {% if has_manager and manager.classic_leagues %}

                {% for league in manager.classic_leagues %}
                {% set r = league.entry_rank %}
                {% set last = league.entry_last_rank %}
                {% set size = league.rank_count %}

                {# Top-3 precedence over bottom üí©; then ‚ñ≤/‚ñº/‚Äî #}
                {% set pod =
                (r in [1,2,3]) and (
                session.current_gw == 38 and ["ü•á","ü•à","ü•â"][r-1] or ["1Ô∏è‚É£","2Ô∏è‚É£","3Ô∏è‚É£"][r-1]
                )
                or (size and r == size) and "üí©"
                or ( last is number and r is number and r < last and "‚ñ≤" or last is number and r is number and r> last
                    and "‚ñº"
                    or "‚Äî" )
                    %}

                    <li class="{{ 'green-text' if (last is number and r is number and r < last)
                         else (last is number and r is number and r > last and 'red-text' or '') }}">
                        <a class="dropdown-item d-flex justify-content-between {% if current_page=='mini_leagues' and league.id==league_id %} active{% endif %}"
                            href="{{ url_for('mini_leagues', league_id=league.id) }}">
                            <span>
                                <span class="me-2">{{ pod }}</span>
                                {{ league.name }} {{ league.name|territory_icon|safe }}
                            </span>
                            <span class="ms-3">
                                ({{ fmt_rank_compact(r) }}{% if size %} of {{ fmt_count_compact(size) }}{% endif %})
                            </span>
                        </a>
                    </li>
                    {% endfor %}

                    {% elif has_manager %}
                    <li><a class="dropdown-item disabled">No mini-leagues</a></li>
                    {% else %}

                    {% endif %}
            </ul>
        </div>
    </nav>
</header>