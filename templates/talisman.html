{% extends "info.html" %}
{% block title %}Talisman{% endblock %}

{% block page_content %}
<div class="col-12">
    <div class="table-responsive table-scroll-viewport sticky-2rows">
        <table id="talisman-table" class="table table-borderless interactive-table table-striped text-nowrap text-center">
            <thead class="th-bg-primary">
                <tr>
                    <th colspan="1" id="top-players" class="sticky-col align-middle round-border-lg-top-left">↑ Top Five
                    </th>
                    <th colspan="2" class="round-border-lg-top-right"></th>
                    <th class="bg-purple round-border-lg-top bg-purple">Fixtures</th>
                    <th colspan="27" class="round-border-lg-top text-start text-lg-center ps-3">Talisman - Only one player per team</th>
                </tr>
                <tr>
                    <th id="entries" class="sticky-col"></th>
    
                    {# --- Overall columns (secondary) --- #}
                    <th data-sort="selected_by_percent" class="sort">%</th>
                    <th data-sort="now_cost" class="sort">£</th>
    
                    <th data-sort="next5_fdr_avg" class="bg-purple">Next 5 FDR</th>
                    <th data-sort="total_points" class="sort">P</th>
                    <th data-sort="starts" class="sort">S</th>
                    <th data-sort="minutes" class="sort">M</th>
                    <th data-sort="defensive_contribution" class="sort">DC</th>
                    <th data-sort="defensive_contribution_per_90" class="sort">DC90</th>
                    <th data-sort="clean_sheets" class="sort">CS</th>
                    <th data-sort="clean_sheets_per_90" class="sort">CS90</th>
    
                    <th data-sort="goals_scored" class="sort">G</th>
                    <th data-sort="expected_goals" class="sort">xG</th>
                    <th data-sort="goals_performance" class="sort">+/−</th>
                    <th data-sort="expected_goals_per_90" class="sort">xG90</th>
                    <th data-sort="assists" class="sort">A</th>
                    <th data-sort="expected_assists" class="sort">xA</th>
                    <th data-sort="assists_performance" class="sort">+/−</th>
                    <th data-sort="goals_assists" class="sort">GI</th>
                    <th data-sort="expected_goal_involvements" class="sort">xGI</th>
                    <th data-sort="goals_assists_performance" class="sort">+/−</th>
    
                    <th data-sort="dreamteam_count" class="sort">DT</th>
                    <th data-sort="bps" class="sort">BPS</th>
                    <th data-sort="penalties_saved" class="sort">PS</th>
                    <th data-sort="penalties_missed" class="sort">PM</th>
                    <th data-sort="yellow_cards" class="sort">YC</th>
                    <th data-sort="red_cards" class="sort">RC</th>
                    <th data-sort="goals_conceded" class="sort">GC</th>
                    <th data-sort="own_goals" class="sort">OG</th>
    
                </tr>
            </thead>
    
            <tbody>
                <!-- rows injected by script.js -->
            </tbody>
    
            <tfoot>
                <tr class="th-bg-primary text-center">
                    <th class="sticky-col round-border-lg-btm-left"></th>
                    <th colspan="2" class="round-border-lg-btm-right"></th>
                    <th class="bg-purple round-border-lg-btm"></th>
                    <th colspan="27" class="round-border-lg-btm">
                        <div id="loading" style="display:none;">Loading…</div>
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1) Page‐specific lookup for header‐hover tooltips:
    const managerName = {{ manager.team_name | default ('', true) | tojson }};
    const lookup = {

        "selected_by_percent": "Teams selected by",
        "now_cost": "Current price",
        "next5_fdr_avg": "Average difficulty of next five matches",
        "total_points": "Total points",
        "starts": "Total starts",
        "minutes": "Total minutes",
        "defensive_contribution": "Total defensive contributions",
        "defensive_contribution_per_90": "Defensive contributions per 90",
        "clean_sheets": "Total clean sheets",
        "clean_sheets_per_90": "Clean sheets per 90",
        "dreamteam_count": "Total Dreamteam appearances",
        "bps": "Total BPS",
        "penalties_saved": "Total penalties saved",
        "yellow_cards": "Total yellow cards",
        "red_cards": "Total red cards",
        "goals_conceded": "Total goals conceded",
        "own_goals": "Total own goals",
        "penalties_missed": "Total penalties missed",
        "top-players": "Pictures of the top players for this category",
        "entries": "Number of entries",
        "overall-data": "Overall stats",

        "goals_scored": `Total goals scored`,
        "expected_goals": `Total expected goals`,
        "expected_goals_per_90": `Expected goals per 90`,
        "goals_performance": `Goals scored vs expected goals`,
        "assists": `Total assists`,
        "expected_assists": `Expected assists`,
        "assists_performance": `Assists vs expected assists`,
        "goals_assists": `Total goals + assists`,
        "expected_goal_involvements": `Total xG+xA`,
        "goals_assists_performance": `G+A vs xG+xA`,
        "top-players": `Top player pictures`,
        "entries": `Number of players`,
        "team-data": `Team stats`,
        "overall-data": `Overall stats`
    };

    // 1.5) Escape for HTML attributes (safety for title)
        const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

        // Render one leg/pill
        function legCell(leg) {
            if (!leg) return `<span class="fx blank">–</span>`;
            const opp = leg.opp_short ?? "?";
            const text = leg.is_home ? opp.toUpperCase() : opp.toLowerCase();
            const dif = leg.difficulty ?? "x";         // falls back to 'x'
            const ha = leg.is_home ? "home" : "away";
            const tbc = leg.tbc ? "<sup>*</sup>" : "";
            const when = leg.kickoff_time_utc
                ? new Date(leg.kickoff_time_utc).toLocaleString("en-GB", { day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" })
                : "";
            const title = `${opp} ${leg.is_home ? "H" : "A"} · FDR ${dif}${when ? " · " + when : ""}`;
            return `<span class="fx ${ha} dif_${dif}" title="${esc(title)}">${text}${tbc}</span>`;
        }

    // 2) Now inject the shared tableConfig for `script.js` to pick up:
    window.tableConfig = {
        table: "talisman",
        url: `/get-sorted-players?table=talisman&team_id={{ team_id }}`,
        tbodySelector: "#talisman-table tbody",
        loadingSelector: "#talisman-loading",
        currentGw: {{ (current_gw or 1)| int }},
        sortBy: "{{ sort_by }}",
        sortOrder: "{{ order }}",
        lookup: lookup,
        // columns tells script.js what to render, in order:
        columns: [
            // rank + name
            {
                render: (p, idx) => {
                    const short = p.web_name.length > 11 ? p.web_name.slice(0, 10) + '…' : p.web_name;
                    const badgeUrl = `https://resources.premierleague.com/premierleague/badges/100/t${p.team_code}@x2.png`;

                    return `

                    <td class="sticky-col vert-border-end vert-border">
                    <div class="d-flex align-items-center">
                        <div class="text-center" style="width:2ch; flex:0 0 auto;">${idx + 1}</div>
                        <img 
                            src="${badgeUrl}"
                            alt="${p.team_name} badge"
                            class="img-fluid overlap-badge ms-1"
                            data-bs-toggle="tooltip"
                            title="${p.team_name}"
                            style="width: 20px; height: 20px; flex:0 0 auto;"
                            onerror="this.onerror=null;this.src='https://resources.premierleague.com/premierleague/photos/players/110x140/Photo-Missing.png';"
                        >
                        <div class="ms-1">${short}</div>
                        <div class="">&nbsp;&nbsp;&nbsp;&nbsp;</div>
                    </div>
                    </td>`;
                }
            },


            // columns:
            { key: "selected_by_percent", className: "sort", dataColumn: "selected_by_percent", formatter: v => `${parseFloat(v).toFixed(0)}%` } ,
            { key: "now_cost", className: "sort vert-border", dataColumn: "now_cost", formatter: v => `£${(v/10).toFixed(1)}m`},

            // Fixtures
            {
                key: "next5",
                header: "Next 5",
                className: "fx5-col", dataColumn: "next5_fdr_sum",
                render: r => {
                    const legs = r.upcoming_fixtures || [];
                    let html = "";
                    for (let i = 0; i < 5; i++) html += legCell(legs[i] || null);
                    return `<div class="fx5 sort font-monospace  vert-border vert-border-end">${html}</div>`;
                }
            },
            { key: "total_points", className: "sort vert-border", dataColumn: "total_points" },
            { key: "starts", className: "sort vert-border", dataColumn: "starts" },
            { key: "minutes", className: "sort", dataColumn: "minutes" },

            { key: "defensive_contribution", className: "sort vert-border", dataColumn: "defcon" },
            { key: "defensive_contribution_per_90", className: "sort", dataColumn: "defcon_90" },
            { key: "clean_sheets", className: "sort vert-border", dataColumn: "clean_sheets" },
            { key: "clean_sheets_per_90", className: "sort", dataColumn: "clean_sheets_per_90", formatter: v => (v).toFixed(2) },

            { key: 'goals_scored', dataColumn: "goals_scored ", className: 'sort vert-border' },
            { key: 'expected_goals', dataColumn: "expected_goals", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: 'goals_performance', dataColumn: "goals_performance", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: 'expected_goals_per_90', dataColumn: "expected_goals_per_90", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            
            { key: 'assists', dataColumn: "assists", className: 'sort vert-border' },
            { key: 'expected_assists', dataColumn: "expected_assists", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: 'assists_performance', dataColumn: "assists_performance", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            
            { key: 'goals_assists', dataColumn: "goals_assists", className: 'sort vert-border' },
            { key: 'expected_goal_involvements', dataColumn: "expected_goal_involvements", className: 'sort', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },
            { key: 'goals_assists_performance', dataColumn: "goals_assists_performance", className: 'sort vert-border-end', formatter: v => (Math.round(v * 10) / 10).toFixed(1) },

            
            { key: "dreamteam_count", className: "sort", dataColumn: "dreamteam_count" },
            { key: "bps", className: "sort", dataColumn: "bps" },
            { key: "penalties_saved", className: "sort", dataColumn: "penalties_saved" },
            // Negatives
            { key: "penalties_missed", className: "sort text-danger vert-border-end", dataColumn: "penalties_missed" },
            { key: "yellow_cards", className: "sort text-danger vert-border", dataColumn: "yellow_cards" },
            { key: "red_cards", className: "sort text-danger", dataColumn: "red_cards" },
            { key: "goals_conceded", className: "sort text-danger vert-border", dataColumn: "goals_conceded" },
            { key: "own_goals", className: "sort text-danger vert-border-end", dataColumn: "own_goals" },
        ]
    };


    (() => {
        const wraps = document.querySelectorAll('.table-scroll-viewport.sticky-2rows');
        wraps.forEach(wrap => {
            const row1 = wrap.querySelector('thead tr:first-child');
            if (!row1) return;
            const setTop = () => wrap.style.setProperty('--th-row1-h', (row1.getBoundingClientRect().height || 0) + 'px');
            setTop();
            addEventListener('resize', setTop, { passive: true });
            if ('ResizeObserver' in window) new ResizeObserver(setTop).observe(row1);
        });
    })();
</script>


{% endblock %}