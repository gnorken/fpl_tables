{% extends "info_mini_leagues.html" %}

{% block title %}Mini Leagues{% endblock %}

{% block page_content %}

<div class="container-fluid">
  <!-- ================= TABLE A: SUMMARY ================= -->
  <div class="table-responsive pe-2 mb-3">
    <table id="mini-league-summary" class="table table-sm interactive-table table-striped text-nowrap">
      <thead class="th-bg-primary small">
        <tr class="text-center th-padding text-wrap" data-table="summary">
          <!-- Rank -->
          <th data-sort="rank" class="sort">Rank</th>
          <th data-sort="overall_rank" class="sort">OR</th>

          <!-- Manager info-->
          <th data-sort="player_name" class="sort sticky-col text-start">Name</th>
          <th data-sort="last_deadline_value" class="sort text-start">Value</th>
          <th data-sort="years_active" class="sort text-start">Season</th>

          <!-- Current GW -->
          <th data-sort="captain_current_points" class="sort" colspan="2">GW{{ current_gw }} Captain</th>
          <th data-sort="active_chip_sort" class="sort">GW{{ current_gw }} Chip</th>
          <th data-sort="summary_event_points" class="sort">GW{{ current_gw }} Pts</th>

          <!-- Points -->
          <th data-sort="total_points" class="sort">Total Points</th>
          <th data-sort="pts_behind_league_leader" class="sort">Trailing</th>
          <th data-sort="pts_behind_overall" class="sort">Trailing OR</th>

          <!-- Chips -->
          <th data-sort="wildcard1_gw" class="sort">WC</th>
          <th data-sort="3xc_gw" class="sort text-center">3x_C</th>
          <th data-sort="bboost_gw" class="sort">BB</th>
          <th data-sort="freehit_gw" class="sort">FH</th>

          <!-- Transfers -->
          <th data-sort="last_deadline_total_transfers" class="sort text-start">Transfers</th>
          <th data-sort="transfer_cost" class="sort">Hits</th>
        </tr>
      </thead>
      <tbody id="summary-body"></tbody>
      <tfoot class="th-bg-primary">
        <tr>
          <th colspan="18" class="round-border-btm text-center">
            <div id="loading-summary" style="display:none">Loading…</div>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- ================= TABLE B: BREAKDOWN ================= -->
  <div class="table-responsive pe-2">
    <table id="mini-league-breakdown" class="table table-sm interactive-table table-striped text-nowrap">
      <thead class="th-bg-primary small">
        <tr class="text-center th-padding text-wrap" data-table="breakdown">
          <!-- Identity -->
          <th data-sort="rank" class="sort">Rank</th>
          <th data-sort="player_name" class="sort sticky-col text-start">Name</th>

          <!-- Breakdown -->
          <th data-sort="captain_points_team" class="sort">Captain Points</th>
          <th data-sort="goals_scored_team" class="sort">Goals</th>
          <th data-sort="assists_team" class="sort">Assists</th>
          <th data-sort="minutes_team" class="sort">Minutes</th>
          <th data-sort="defensive_contribution_team" class="sort">Def Con</th>
          <th data-sort="clean_sheets_team" class="sort">Clean Sheets</th>
          <th data-sort="bonus_team" class="sort">Bonus Points</th>
          <th data-sort="dreamteam_count_team" class="sort">Dream Team</th>

          <!-- Negatives -->
          <th data-sort="yellow_cards_team" class="sort">Yellow Cards</th>
          <th data-sort="red_cards_team" class="sort">Red Cards</th>
        </tr>
      </thead>
      <tbody id="breakdown-body"></tbody>
      <tfoot class="th-bg-primary">
        <tr>
          <th colspan="12" class="round-border-btm text-center">
            <div id="loading-breakdown">Loading…</div>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Rows-per-page (applies to both tables) -->
<div class="mb-1 ms-1 d-flex align-items-center">
  <label for="rows-per-page" class="me-2">Show:</label>
  <select id="rows-per-page" class="form-select w-auto">
    {% for n in [5,10,25,50] %}
    <option value="{{ n }}" {% if n==maxShow %} selected {% endif %}>{{ n }}</option>
    {% endfor %}
  </select>
</div>

<script>
  // ---------- Shared lookup used by both configs ----------
  const sharedLookup = {
    rank: "Mini-league rank",
    overall_rank: "Overall rank",
    player_name: "Manager name and team name",
    team_name: "Team name",
    years_active: "Nationality and years active as an FPL manager",
    last_deadline_value: "Team value and money in the bank",
    total_points: "Total points",
    pts_behind_league_leader: "Trailing mini league leader by",
    pts_behind_overall: "Trailing overall leader by",
    minutes_team: "Total minutes played",
    defensive_contribution_team: "Points for defensive contribution",
    last_deadline_total_transfers: "Total transfers made",
    transfer_cost: "Minus points for hits",
    captain_points_team: "Captain points for the season",
    captain_current_points: "Total Captain points this gameweek",
    clean_sheets_team: "Clean sheets",
    goals_scored_team: "Goals scored",
    goals_benched_team: "Goals benched",
    assists_team: "Assists",
    bonus_team: "Bonus Points",
    dreamteam_count_team: "Times in Dream Team",
    yellow_cards_team: "Yellow cards",
    red_cards_team: "Red cards",
    active_chip: "Chip played this gameweek",
    wildcard1_gw: "Wildcards",
    wildcard2_gw: "Wildcards (second)",
    "3xc_gw": "Triple captains",
    bboost_gw: "Bench boosts",
    freehit_gw: "Free hits",
    summary_event_points: "Gameweek {{ current_gw }} points",
    active_chip_sort: "Chip used this gameweek"
  };

  const sharedInvert = [
    "rank", "overall_rank",
    "yellow_cards_team", "red_cards_team", "own_goals_team",
    "penalties_missed_team", "goals_benched_team", "points_behind", "transfer_cost"
  ];

  const sharedStats = [
    "years_active",
    "rank", "overall_rank", "total_points", "pts_behind_league_leader", "pts_behind_overall",
    "wildcard1_gw", "wildcard2_gw", "3xc_gw", "bboost_gw", "freehit_gw",
    "last_deadline_total_transfers", "transfer_cost",
    "captain_points_team",
    "goals_scored_team", "goals_benched_team",
    "minutes_team", "clean_sheets_team", "defensive_contribution_team",
    "assists_team",
    "bonus_team", "dreamteam_count_team",
    "yellow_cards_team", "red_cards_team", "summary_event_points"
  ];

  // ---------- Column defs (reusing your existing renderers) ----------
  const summaryColumns = [
    {
      key: "rank",
      render: t => {
        const v = t.rank;
        if (v == null) return "<td></td>";
        const formatted = (v >= 1_000_000) ? (v / 1_000_000).toFixed(1) + "M" : (v >= 1_000 ? (v / 1_000).toFixed(1) + "K" : v.toLocaleString("de-CH"));
        let arrow = "";
        if (typeof t.last_rank === "number") {
          if (v < t.last_rank) arrow = ' <span class="text-success">&#9650;</span>';
          else if (v > t.last_rank) arrow = ' <span class="text-danger">&#9660;</span>';
          else arrow = ' <span class="text-muted">&#8211;</span>';
        }
        return `<td class="vert-border">${formatted}${arrow}</td>`;
      }
    },
    {
      key: "overall_rank",
      render: t => {
        const v = t.overall_rank;
        if (v == null) return "<td></td>";
        const formatted = (v >= 1_000_000) ? (v / 1_000_000).toFixed(1) + "M" : (v >= 1_000 ? (v / 1_000).toFixed(1) + "K" : v.toLocaleString("de-CH"));
        let arrow = "";
        if (typeof t.overall_last_rank === "number") {
          if (v < t.overall_last_rank) arrow = ' <span class="text-success">&#9650;</span>';
          else if (v > t.overall_last_rank) arrow = ' <span class="text-danger">&#9660;</span>';
          else arrow = ' <span class="text-muted">&#8211;</span>';
        }
        return `<td class="vert-border">${formatted}${arrow}</td>`;
      }
    },
    {
      key: "player_name",
      render: t => {
        const short = t.player_name.length > 20 ? t.player_name.slice(0, 20) + "…" : t.player_name;
        return `
          <td class="sticky-col vert-border clickable-cell">
            <a href="/${t.entry}/team/summary" class="stretched-link" aria-label="Open ${t.player_name}'s team summary">
              <div class="text-start small fw-bold underline">${short}</div>
              <div class="text-start text-muted small">${t.team_name}</div>
            </a>
          </td>`;
      }
    },
    {
      key: "last_deadline_value",
      render: t => {
        const pounds = (t.last_deadline_value / 10).toFixed(1);
        const bank = (t.last_deadline_bank / 10).toFixed(1);
        return `<td class="vert-border small"><div class="text-start">£${pounds}M</div><div class="text-start">£${bank}M</div></td>`;
      }
    },
    {
      key: "years_active",
      render: t => {
        const linkOpen = t.national_league_url ? `<a href="${t.national_league_url}" class="d-block text-center">` : '<span class="d-block text-center">';
        const linkClose = t.national_league_url ? '</a>' : '</span>';
        return `
          <td class="vert-border vert-border-end clickable-cell">
            ${linkOpen}
              <div class="text-start"><span class="fi fi-${t.country_code}"></span> ${t.player_region_iso_code_long}</div>
              <div class="text-start text-muted small">${t.years_active_label} season</div>
            ${linkClose}
          </td>`;
      }
    },
    {
      key: "captain_current",
      render: (t) => {
        const teamCode = t.captain_current_team_code ?? 0;
        const teamName = t.captain_current_team || "N/A";
        const capName = t.captain_current_name || "N/A";
        const mult = Number(t.captain_current_multiplier ?? 1);
        const pending = !!t.captain_current_pending;
        const hasPts = Number.isFinite(t.captain_current_points);
        const capText = pending ? "⏳" : (hasPts ? `${t.captain_current_points}` : "—");
        const capTitle = pending ? `Pending${mult === 3 ? "<br>Triple Captain" : ""}` : "";
        const tdAttrs = pending
          ? `data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${capTitle}"`
          : `aria-label="${capName} — ${capText}${mult === 3 ? " (Triple Captain)" : ""}"`;
        const badgeSrc = teamCode ? `https://resources.premierleague.com/premierleague/badges/100/t${teamCode}@x2.png` : "";
        return `
          <td class="text-center pe-1 ps-2">
            ${badgeSrc ? `<img src="${badgeSrc}" alt="${teamName} badge" class="badge_mini_league" data-bs-toggle="tooltip" title="${teamName}" aria-label="${teamName}" onerror="this.style.display='none';">` : ""}
          </td>
          <td ${tdAttrs} class="pe-2">
            <div class="fw-bold small">${capName}</div>
            <div class="small">${capText}</div>
          </td>`;
      }
    },
    {
      key: "active_chip",
      render: (t) => {
        const label = t.active_chip || "-";
        const sortVal = label ? label.toLowerCase() : "\uFFFF";
        return `<td class="text-center small text-wrap" data-column="active_chip" data-sort-value="${sortVal}">${label ? `<span>${label}</span>` : ""}</td>`;
      }
    },
    {
      key: "summary_event_points",
      render: (t) => {
        const v = t.summary_event_points;
        const pending = t.summary_event_points_pending;
        const label = (v == null && pending) ? "⏳" : String(v ?? 0);
        const title = pending ? "Gameweek in progress" : "Event points";
        return `<td class="${pending ? "text-muted" : ""}" title="${title}">${label}</td>`;
      }
    },
    { key: "total_points", className: "vert-border" },
    { key: "pts_behind_league_leader" },
    { key: "pts_behind_overall" },
    {
      key: "wildcards_gw",
      render: (t) => {
        const wc1 = t.wildcard1_gw, wc2 = t.wildcard2_gw;
        const icon = (label, gw, idx = null) => {
          const used = Number.isFinite(gw) && gw > 0;
          const header = `${label}${idx ? ` #${idx}` : ""}`;
          const body = used ? `Used in GW ${gw}` : `Not used`;
          return `<span class="chip-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${header}<br>${body}">${used ? "✅" : "⬜️"}</span>`;
        };
        return `<td class="vert-border vert-border">${icon("Wildcard", wc1, 1)}<br>${icon("Wildcard", wc2, 2)}</td>`;
      }
    },
    {
      key: "3xc_gw",
      render: (t) => {
        const c1 = t["3xc_gw"], c2 = t["3xc2_gw"];
        const icon = (label, gw, idx = null) => {
          const used = Number.isFinite(gw) && gw > 0;
          const header = `${label}${idx ? ` #${idx}` : ""}`;
          const body = used ? `Used in GW ${gw}` : `Not used`;
          return `<span class="chip-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${header}<br>${body}">${used ? "✅" : "⬜️"}</span>`;
        };
        return `<td>${icon("Triple Captain", c1, 1)}<br>${icon("Triple Captain", c2, 2)}</td>`;
      }
    },
    {
      key: "bboost_gw",
      render: (t) => {
        const bb1 = t.bboost_gw, bb2 = t.bboost2_gw;
        const icon = (label, gw, idx = null) => {
          const used = Number.isFinite(gw) && gw > 0;
          const header = `${label}${idx ? ` #${idx}` : ""}`;
          const body = used ? `Used in GW ${gw}` : `Not used`;
          return `<span class="chip-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${header}<br>${body}">${used ? "✅" : "⬜️"}</span>`;
        };
        return `<td>${icon("Bench Boost", bb1, 1)}<br>${icon("Bench Boost", bb2, 2)}</td>`;
      }
    },
    {
      key: "freehit_gw",
      render: (t) => {
        const fh1 = t.freehit_gw, fh2 = t.freehit2_gw;
        const icon = (label, gw, idx = null) => {
          const used = Number.isFinite(gw) && gw > 0;
          const header = `${label}${idx ? ` #${idx}` : ""}`;
          const body = used ? `Used in GW ${gw}` : `Not used`;
          return `<span class="chip-icon" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${header}<br>${body}">${used ? "✅" : "⬜️"}</span>`;
        };
        return `<td>${icon("Free Hit", fh1, 1)}<br>${icon("Free Hit", fh2, 2)}</td>`;
      }
    },
    { key: "last_deadline_total_transfers", className: "vert-border" },
    { key: "transfer_cost", className: "text-danger vert-border-end" }
  ];

  const breakdownColumns = [
    {
      key: "rank",
      render: t => {
        const v = t.rank;
        if (v == null) return "<td></td>";
        const formatted = (v >= 1_000_000) ? (v / 1_000_000).toFixed(1) + "M" : (v >= 1_000 ? (v / 1_000).toFixed(1) + "K" : v.toLocaleString("de-CH"));
        let arrow = "";
        if (typeof t.last_rank === "number") {
          if (v < t.last_rank) arrow = ' <span class="text-success">&#9650;</span>';
          else if (v > t.last_rank) arrow = ' <span class="text-danger">&#9660;</span>';
          else arrow = ' <span class="text-muted">&#8211;</span>';
        }
        return `<td class="vert-border">${formatted}${arrow}</td>`;
      }
    },
    {
      key: "player_name",
      render: t => {
        const short = t.player_name.length > 20 ? t.player_name.slice(0, 20) + "…" : t.player_name;
        return `
          <td class="sticky-col vert-border clickable-cell">
            <a href="/${t.entry}/team/summary" class="stretched-link" aria-label="Open ${t.player_name}'s team summary">
              <div class="text-start small fw-bold underline">${short}</div>
              <div class="text-start text-muted small">${t.team_name}</div>
            </a>
          </td>`;
      }
    },
    { key: "captain_points_team", className: "vert-border" },
    { key: "goals_scored_team" },
    // { key: "expected_goals_team" },
    { key: "assists_team" },
    { key: "minutes_team" },
    { key: "defensive_contribution_team" },
    { key: "clean_sheets_team" },
    { key: "bonus_team" },
    { key: "dreamteam_count_team" },
    { key: "yellow_cards_team", className: "vert-border text-danger" },
    { key: "red_cards_team", className: "text-danger vert-border-end" }
  ];

  // ---------- Two configs that your existing script.js will consume ----------
  const summaryConfig = {
    url: `/mini-league-summary?league_id={{ league_id }}`,
    table: "mini_league",
    tbodySelector: "#summary-body",
    loadingSelector: "#loading-summary",
    sortBy: {{ sort_by | tojson }},
  sortOrder: {{ order | tojson }},
  maxShow: {{ maxShow }},
  lookup: sharedLookup,
    invertKeys: sharedInvert,
      statsKeys: sharedStats,
        columns: summaryColumns,
          currentEntry: {{ session.get('team_id', none) | tojson }}
  };

  const breakdownConfig = {
    url: `/mini-league-breakdown?league_id={{ league_id }}`,
    table: "mini_league",
    tbodySelector: "#breakdown-body",
    loadingSelector: "#loading-breakdown",
    sortBy: "captain_points_team",
    sortOrder: "desc",
    maxShow: {{ maxShow }},
  lookup: sharedLookup,
    invertKeys: sharedInvert,
      statsKeys: sharedStats,
        columns: breakdownColumns,
          currentEntry: {{ session.get('team_id', none) | tojson }}
  };

  window.tableConfig = summaryConfig;

  // ---------- Orchestration (no changes to script.js required) ----------
  document.addEventListener("DOMContentLoaded", async () => {

    // 2) Then, defer BREAKDOWN until the browser is idle (or a short delay)
    const startBreakdown = () => {
      window.tableConfig = breakdownConfig;
      window.fetchData(breakdownConfig.sortBy, breakdownConfig.sortOrder);
    };

    if ("requestIdleCallback" in window) {
      requestIdleCallback(startBreakdown, { timeout: 1000 });
    } else {
      setTimeout(startBreakdown, 250);
    }

    // 3) Independent sorting per table (unchanged)
    document
      .querySelectorAll('#mini-league-summary thead th[data-sort]')
      .forEach((th) => {
        th.addEventListener("click", (e) => {
          e.stopPropagation();
          const key = th.dataset.sort;
          const dir =
            summaryConfig.sortBy === key && summaryConfig.sortOrder === "desc"
              ? "asc"
              : "desc";
          summaryConfig.sortBy = key;
          summaryConfig.sortOrder = dir;
          window.tableConfig = summaryConfig;
          window.fetchData(key, dir);
        });
      });

    document
      .querySelectorAll('#mini-league-breakdown thead th[data-sort]')
      .forEach((th) => {
        th.addEventListener("click", (e) => {
          e.stopPropagation();
          const key = th.dataset.sort;
          const dir =
            breakdownConfig.sortBy === key && breakdownConfig.sortOrder === "desc"
              ? "asc"
              : "desc";
          breakdownConfig.sortBy = key;
          breakdownConfig.sortOrder = dir;
          window.tableConfig = breakdownConfig;
          window.fetchData(key, dir);
        });
      });

    // 4) Rows-per-page → apply to both tables
    const rowsSel = document.getElementById("rows-per-page");
    if (rowsSel) {
      rowsSel.addEventListener("change", () => {
        const n = parseInt(rowsSel.value, 10);
        summaryConfig.maxShow = n;
        breakdownConfig.maxShow = n;

        window.tableConfig = summaryConfig;
        window.fetchData(summaryConfig.sortBy, summaryConfig.sortOrder);

        // Stagger Breakdown refresh slightly to avoid bursts
        setTimeout(() => {
          window.tableConfig = breakdownConfig;
          window.fetchData(breakdownConfig.sortBy, breakdownConfig.sortOrder);
        }, 150);
      });
    }
  });
</script>

{% endblock %}