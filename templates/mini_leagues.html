{% extends "info_mini_leagues.html" %}


{% block title %}Mini Leagues{% endblock %}

{% block page_content %}

<div class="container-fluid">
  <div class="table-responsive pe-2">
    <table id="mini-league-table" class="table table-sm interactive-table table-striped text-nowrap">
      <thead class="th-bg-primary small">
        <!-- <tr class="text-center"> -->
          <!-- <th colspan="2" class="">Team</th>
          <th colspan="1" class="sticky-col  text-start text-lg-center">Manager</th>
          <th colspan="2" class="">Ranks</th>
          <th colspan="3" class="">Points</th>
          <th colspan="4" class="">Chips</th>
          <th colspan="2" class="">Transfers</th>
          <th colspan="8" class="">Breakdown</th> -->
          <!-- <th colspan="4" class="-right">Negatives</th> -->
        <!-- </tr>  -->
        <tr class="text-center th-padding">

          <!-- Rank -->
          <th id="rank" data-sort="rank" class="sort">Rank</th>
          <th id="overall_rank" data-sort="overall_rank" class="sort">OR</th>

          <!-- Manager info-->
          <th id="player_name" data-sort="player_name" class="sort sticky-col text-start">Name</th>
          <th id="last_deadline_value" data-sort="last_deadline_value" class="sort text-start">Value</th>
          <th id="years_active" data-sort="years_active" class="sort text-start">Season</th>

          <!-- Current GW-->
          <th id="captain_current_points" data-sort="captain_current_points" class="sort" colspan="2">GW{{ current_gw }} Captain</th>
          <th id="active_chip" data-sort="active_chip_sort" class="sort">GW{{ current_gw }} Chip</th>
          <th id="summary_event_points" data-sort="summary_event_points" class="sort">GW{{ current_gw }} Pts</th>


          <!-- Points -->
          <th id="total_points" data-sort="total_points" class="sort">Pts</th>
          <th id="pts_behind_league_leader" data-sort="pts_behind_league_leader" class="sort">T</th>
          <th id="pts_behind_overall" data-sort="pts_behind_overall" class="sort">T OR</th>
      
          <!-- Chips -->
          <th id="wildcard1_gw" data-sort="wildcard1_gw" class="sort">WC</th>
          <th id="3xc_gw" data-sort="3xc_gw" class="sort text-center">3x C</th>
          <th id="bboost_gw" data-sort="bboost_gw" class="sort">BB</th>
          <th id="freehit_gw" data-sort="freehit_gw" class="sort">FH</th>
          <!-- <th id="manager_gw" data-sort="manager_gw" class="sort">AM</th> -->

          <!-- Transfers -->
          <th id="last_deadline_total_transfers" data-sort="last_deadline_total_transfers" class="sort text-start">T  </th>
          <th id="transfer_cost" data-sort="transfer_cost" class="sort">Hits</th>

          <!-- Breakdown -->
          <th id="captain_points_team" data-sort="captain_points_team" class="sort">CP</th>
          <th id="goals_scored_team" data-sort="goals_scored_team" class="sort ">G</th>
          <th id="assists_team" data-sort="assists_team" class="sort ">A</th>
          <th id="minutes_team" data-sort="minutes_team" class="sort ">Mi</th>
          <th id="defensive_contribution_team" data-sort="defensive_contribution_team" class="sort ">DC</th>
          <th id="clean_sheets_team" data-sort="clean_sheets_team" class="sort">CS</th>
          <th id="bonus_team" data-sort="bonus_team" class="sort">B</th>
          <th id="dreamteam_count_team" data-sort="dreamteam_count_team" class="sort">DT</th>

          <!-- Negatives -->
          <th id="yellow_cards_team" data-sort="yellow_cards_team" class="sort ">Y</th>
          <th id="red_cards_team" data-sort="red_cards_team" class="sort">R</th>
          <!-- <th id="own_goals_team" data-sort="own_goals_team" class="sort">OGs</th>
          <th id="penalties_missed_team" data-sort="penalties_missed_team" class="sort">PM</th> -->
        </tr>
      </thead>
      <tbody id="mini-league-table-body">
      </tbody>
      <tfoot class="th-bg-primary">
        <tr>
          <th colspan="28" class="round-border-btm text-center"><div id="loading" style="display:none">Loading</div></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
<!-- ─── Rows-per-page dropdown ─────────────────────────── -->
<div class="mb-1 ms-1 d-flex align-items-center">
  <label for="rows-per-page" class="me-2">Show:</label>
  <select id="rows-per-page" class="form-select w-auto">
    {% for n in [5,10,20, 50] %}
    <option value="{{ n }}" {% if n==maxShow %} selected {% endif %}>{{ n }}</option>
    {% endfor %}
  </select>
</div>

<script>
  // ─── Helpers ──────────────────────────────
  function formatRank(v) {
    if (v == null) return "";
    if (v >= 1_000_000) return (v / 1_000_000).toFixed(1) + "M";
    if (v >= 1_000) return (v / 1_000).toFixed(1) + "K";
    return v.toLocaleString("de-CH");
  }

  function chipIcon(label, gw, idx = null) {
    const used = Number.isFinite(gw) && gw > 0;
    const header = `${label}${idx ? ` #${idx}` : ""}`;
    const body = used ? `Used in GW ${gw}` : `Not used`;
    const html = `${header}<br>${body}`;
    return `
    <span class="chip-icon"
          data-bs-toggle="tooltip"
          data-bs-html="true"
          data-bs-title="${html.replace(/"/g, "&quot;")}"
          aria-label="${header}: ${body}">
      ${used ? "✅" : "⬜️"}
    </span>
  `;
  }

  /** Render a chip <td> with fixed slots (default 2). */
  function chipTd(label, gws, classes = "", slots = 2) {
    const arr = Array.from({ length: slots }, (_, i) => gws[i] ?? null);
    const lines = arr.map((gw, i) => chipIcon(label, gw, slots > 1 ? i + 1 : null)).join("<br>");
    return `<td class="${classes}">${lines}</td>`;
  }

  // ─── Sorter helpers (global) ──────────────────────────────
  function getSortValue(td) {
    if (!td) return "";
    return td.dataset?.sortValue ?? td.textContent.trim();
  }

  const numericKeys = new Set([
    "rank", "overall_rank", "total_points", "pts_behind_league_leader", "pts_behind_overall",
    "wildcard1_gw", "wildcard2_gw", "3xc_gw", "bboost_gw", "freehit_gw",
    "last_deadline_total_transfers", "transfer_cost", "captain_points_team",
    "goals_scored_team", "expected_goals_team", "goals_benched_team",
    "minutes_team", "clean_sheets_team", "defensive_contribution_team",
    "assists_team", "expected_assists_team", "bonus_team", "dreamteam_count_team",
    "yellow_cards_team", "red_cards_team", "own_goals_team", "penalties_missed_team",
    "years_active", "summary_event_points"
  ]); // NOTE: not including "active_chip"

  function compareRows(aTd, bTd, key) {
    const a = getSortValue(aTd);
    const b = getSortValue(bTd);
    if (numericKeys.has(key)) {
      let an = parseFloat(a), bn = parseFloat(b);
      if (Number.isNaN(an)) an = Number.POSITIVE_INFINITY;
      if (Number.isNaN(bn)) bn = Number.POSITIVE_INFINITY;
      return an - bn;
    }
    return String(a).localeCompare(String(b), undefined, { sensitivity: "base" });
  }

  // ─── Mini-League Page Config ──────────────────────────────
  window.tableConfig = {
    url: `/get-sorted-players?league_id={{ league_id }}&table=mini_league&team_id={{ session.team_id|default('') }}`,
    table: "mini_league",
    tbodySelector: "#mini-league-table-body",
    loadingSelector: "#loading",
    sortBy: {{ sort_by | tojson }},
    sortOrder: {{ order | tojson }},
    maxShow: {{ maxShow }},

  lookup: {
    rank: "Minileague rank",
      overall_rank: "Overall rank",
        player_name: "Manager name and team name",
          team_name: "Team name",
            years_active: "Nationality and years active as an FPL manager",
              last_deadline_value: "Team value and money in the bank",
                total_points: "Total points",
                  pts_behind_league_leader: "Trailing mini league leader by",
                    pts_behind_overall: "Trailing overall leader by",
                      minutes_team: "Total minutes played",
                        defensive_contribution_team: "Points for defensive contribution",
                          last_deadline_total_transfers: "Total transfers made",
                            transfer_cost: "Minus points for hits",
                              captain_points_team: "Captain points for the season",
                                captain_current_points: "Total Captain points this gameweek",
                                  clean_sheets_team: "Clean sheets",
                                    goals_scored_team: "Goals scored",
                                      goals_benched_team: "Goals benched",
                                        assists_team: "Assists",
                                          expected_goals_team: "Expected Goals",
                                            expected_assists_team: "Expected Assists",
                                              bonus_team: "Bonus Points",
                                                dreamteam_count_team: "Times in Dream Team",
                                                  yellow_cards_team: "Yellow cards",
                                                    red_cards_team: "Red cards",
                                                      own_goals_team: "Own goals",
                                                        penalties_missed_team: "Penalties Missed",
                                                          active_chip: "Chip played this gameweek",
                                                            wildcard1_gw: "Wildcards",
                                                              wildcard2_gw: "Wildcards (second)",
                                                                "3xc_gw": "Triple captains",
                                                                  bboost_gw: "Bench boosts",
                                                                    freehit_gw: "Free hits",
                                                                      summary_event_points: "Gameweek {{ current_gw }} points",
                                                                        active_chip_sort: "Chip used this gameweek"
  },

  invertKeys: [
    "rank", "overall_rank",
    "yellow_cards_team", "red_cards_team", "own_goals_team",
    "penalties_missed_team", "goals_benched_team", "points_behind", "transfer_cost"
  ],

    // numeric-only keys (strings like active_chip excluded)
    statsKeys: [
      "years_active",
      "rank", "overall_rank", "total_points", "pts_behind_league_leader", "pts_behind_overall",
      "wildcard1_gw", "wildcard2_gw", "3xc_gw", "bboost_gw", "freehit_gw",
      "last_deadline_total_transfers", "transfer_cost",
      "captain_points_team",
      "goals_scored_team", "expected_goals_team", "goals_benched_team",
      "minutes_team", "clean_sheets_team", "defensive_contribution_team",
      "assists_team", "expected_assists_team",
      "bonus_team", "dreamteam_count_team",
      "yellow_cards_team", "red_cards_team", "own_goals_team", "penalties_missed_team", "summary_event_points"
    ],

      columns: [
          {
          key: "rank",
          title: "Rank",
          render: t => {
            const v = t.rank;
            if (v == null) return "<td></td>";
            const formatted = formatRank(v);
            let arrow = "";
            if (typeof t.last_rank === "number") {
              if (v < t.last_rank) arrow = ' <span class="text-success">&#9650;</span>';
              else if (v > t.last_rank) arrow = ' <span class="text-danger">&#9660;</span>';
              else arrow = ' <span class="text-muted">&#8211;</span>';
            }
            return `<td class="vert-border vert-border-end"">${formatted}${arrow}</td>`;
          }
        },
        {
          key: "overall_rank",
          title: "Overall Rank",
          render: t => {
            const v = t.overall_rank;
            if (v == null) return "<td></td>";
            const formatted = formatRank(v);
            let arrow = "";
            if (typeof t.overall_last_rank === "number") {
              if (v < t.overall_last_rank) arrow = ' <span class="text-success">&#9650;</span>';
              else if (v > t.overall_last_rank) arrow = ' <span class="text-danger">&#9660;</span>';
              else arrow = ' <span class="text-muted">&#8211;</span>';
            }
            return `<td class="vert-border">${formatted}${arrow}</td>`;
          }
        },
         {
          key: "player_name",
          render: t => {
            const short = t.player_name.length > 20 ? t.player_name.slice(0, 20) + '…' : t.player_name;
            return`
            <td class="sticky-col vert-border">
              <a href="/${t.entry}/team/summary" class="d-block">
                <div class="text-start small fw-bold">${short}</div>
                <div class="text-start text-muted small">${t.team_name}</div>
              </a>
            </td>`
          }
        },
        {
          key: "last_deadline_value", 
          render: t => { 
            const pounds = (t.last_deadline_value / 10).toFixed(1); const bank = (t.last_deadline_bank / 10).toFixed(1); 
            return `
            <td class="vert-border small"> 
              <div class="text-start">💰 £${pounds}M</div> <div class="text-start">🏦 £${bank}M</div> 
            </td>`
          }
        },
        {
          key: "years_active",
          render: t => {
            const linkOpen = t.national_league_url
              ? `<a href="${t.national_league_url}" class="d-block text-center">`
              : '<span class="d-block text-center">';
            const linkClose = t.national_league_url ? '</a>' : '</span>';
            return `
          <td class="vert-border  vert-border-end">
            ${linkOpen}
              <div class="text-start"><span class="fi fi-${t.country_code}"></span> ${t.player_region_iso_code_long}</div>
              <div class="text-start text-muted small">${t.years_active_label} season</div>
            ${linkClose}
          </td>`;
          }
        },
        {
          key: "captain_current",
          title: "Captain",
          render: (t) => {
            const teamCode = t.captain_current_team_code ?? 0;
            const teamName = t.captain_current_team || "N/A";
            const capName = t.captain_current_name || "N/A";
            const mult = Number(t.captain_current_multiplier ?? 1);
            const pending = !!t.captain_current_pending;

            const hasPoints = Number.isFinite(t.captain_current_points);
            const capText = pending
              ? "⏳"
              : (hasPoints ? `${t.captain_current_points} point${t.captain_current_points === 1 ? "" : "s"}` : "—");

            const capTitle = pending
              ? `Pending${mult === 3 ? "<br>Triple Captain" : ""}`
              : "";

            const tdAttrs = pending
              ? `data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="${capTitle}"`
              : `aria-label="${capName} — ${capText}${mult === 3 ? " (Triple Captain)" : ""}"`;

            const badgeSrc = teamCode
              ? `https://resources.premierleague.com/premierleague/badges/100/t${teamCode}@x2.png`
              : "";

            return `
          <td class="text-center pe-1 ps-2">
            ${badgeSrc ? `
              <img
                src="${badgeSrc}"
                alt="${teamName} badge"
                class="badge_mini_league"
                data-bs-toggle="tooltip"
                title="${teamName}"
                aria-label="${teamName}"
                onerror="this.style.display='none';">` : ""}
          </td>
          <td ${tdAttrs} class="pe-2">
            <div class="fw-bold small">${capName}</div>
            <div class="small">${capText}</div>
          </td>`;
          }
        },
        {
          key: "active_chip",
          title: "Active Chip",
          render: (t) => {
            const label = t.active_chip || "-";
            const sortVal = label ? label.toLowerCase() : "\uFFFF"; // empties last
            return `
          <td class="text-center small text-wrap"
              data-column="active_chip"
              data-sort-value="${sortVal}">
            ${label ? `<span class="">${label}</span>` : ""}
          </td>`;
          }
        },
        { key: "summary_event_points", className: ""},
        { key: "total_points", className: "vert-border"},
        { key: "pts_behind_league_leader" },
        { key: "pts_behind_overall" },

        {
          key: "wildcards_gw",
          title: "Wildcards",
          render: (t) => {
            const wc1 = t.wildcard1_gw;
            const wc2 = t.wildcard2_gw;
            return chipTd("Wildcard", [wc1, wc2], "vert-border vert-border", 2);
          }
        },
        {
          key: "3xc_gw",
          title: "3x C",
          render: (t) => {
            const c1 = t["3xc_gw"];
            const c2 = t["3xc2_gw"]; // may be undefined → ⬜️
            return chipTd("Triple Captain", [c1, c2], "", 2);
          }
        },
        {
          key: "bboost_gw",
          title: "Bench Boost",
          render: (t) => {
            const bb1 = t.bboost_gw;
            const bb2 = t.bboost2_gw; // may be undefined → ⬜️
            return chipTd("Bench Boost", [bb1, bb2], "", 2);
          }
        },
        {
          key: "freehit_gw",
          title: "Free Hit",
          render: (t) => {
            const fh1 = t.freehit_gw;
            const fh2 = t.freehit2_gw; // may be undefined → ⬜️
            return chipTd("Free Hit", [fh1, fh2], "", 2);
          }
        },

        { key: "last_deadline_total_transfers", className: "vert-border" },
        { key: "transfer_cost", className: "text-danger" },
        { key: "captain_points_team", className: "vert-border" },
        { key: "goals_scored_team" },
        { key: "assists_team" },
        { key: "minutes_team", className: "" },
        { key: "defensive_contribution_team" },
        { key: "clean_sheets_team" },
        { key: "bonus_team" },
        { key: "dreamteam_count_team" },
        { key: "yellow_cards_team", className: "vert-border text-danger" },
        { key: "red_cards_team", className: "text-danger vert-border-end" }
      ],

        currentEntry: {{ session.get('team_id', none) | tojson }}
};

  // DOM ready: rows-per-page wiring (unchanged)
  document.addEventListener("DOMContentLoaded", () => {
    const rowsSel = document.getElementById("rows-per-page");
    if (rowsSel) {
      rowsSel.addEventListener("change", () => {
        window.tableConfig.maxShow = parseInt(rowsSel.value, 10);
        window.fetchData(window.tableConfig.sortBy, window.tableConfig.sortOrder);
      });
    }
  });
</script>


<!-- then load your shared JS with fetchMiniLeague/fetchData/sortTable in it -->
<!-- <script src="{{ url_for('static', filename='js/script.js') }}"></script> -->

  
{% endblock %}
