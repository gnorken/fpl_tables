{% extends "info.html" %}
{% block title %}Top Scorers{% endblock %}

{% block page_content %}
<div class="col-12">
    <div class="table-responsive table-scroll-viewport sticky-2rows">
        <table id="offence-table" class="interactive-table table table-borderless table-striped text-center text-nowrap">
            <thead class="th-bg-primary">
                <tr class="text-center">
                    <th id="top-players" class="sticky-col round-border-lg-top-left">↑ Top Five
                    </th>
                    <th colspan="2" class="round-border-lg-top-right"></th>
                    <th colspan="15"  class="bg-team round-border-lg-top text-start text-lg-center">Stats for {{ manager.team_name }}</th>
                    <th colspan="11" class="round-border-lg-top text-start text-lg-center">Player Totals</th>
                </tr>
                <tr class="text-center">
                    <th colspan="1" id="entries" data-sort="entries" class="sticky-col">Players</th>
                    <th data-sort="selected_by_percent" class="sort">%</th>
                    <th data-sort="now_cost" class="sort">£</th>
                    
                    <!-- Team columns -->
                    <th data-sort="total_points_team" class="sort-team bg-team">P</th>
                    <th data-sort="goals_scored_team" class="sort-team bg-team">G</th>
                    <th data-sort="expected_goals_team" class="sort-team bg-team">xG</th>
                    <th data-sort="goals_performance_team" class="sort-team bg-team">+/-</th>
                    <th data-sort="expected_goals_per_90_team" class="sort-team bg-team">xG90</th>
                    <th data-sort="goals_benched_team" class="sort-team bg-team">bG</th>
                    <th data-sort="goals_captained_team" class="sort-team bg-team">cG</th>
                    <th data-sort="assists_team" class="sort-team bg-team">A</th>
                    <th data-sort="expected_assists_team" class="sort-team bg-team">xA</th>
                    <th data-sort="assists_performance_team" class="sort-team bg-team">+/-</th>
                    <th data-sort="assists_benched_team" class="sort-team bg-team">bA</th>
                    <th data-sort="assists_captained_team" class="sort-team bg-team">cA</th>
                    <th data-sort="goals_assists_team" class="sort-team bg-team">GI</th>
                    <th data-sort="expected_goal_involvements_team" class="sort-team bg-team">xGI</th>
                    <th data-sort="goals_assists_performance_team" class="sort-team bg-team">+/-</th>
                    <!-- <th data-sort="goals_assists_performance_team_vs_total" class="sort-team bg-team">+/-</th> -->
                    
                    <!-- overall columns -->
                    <th data-sort="total_points" class="sort">P</th>
                    <th data-sort="goals_scored" class="sort">G</th>
                    <th data-sort="expected_goals" class="sort">xG</th>
                    <th data-sort="goals_performance" class="sort">+/-</th>
                    <th data-sort="expected_goals_per_90" class="sort">xG90</th>
                    <th data-sort="assists" class="sort">A</th>
                    <th data-sort="expected_assists" class="sort">xA</th>
                    <th data-sort="assists_performance" class="sort">+/-</th>
                    <th data-sort="goals_assists" class="sort">GI</th>
                    <th data-sort="expected_goal_involvements" class="sort">xGI</th>
                    <th data-sort="goals_assists_performance" class="sort">+/-</th>
                </tr>
            </thead>
            <tbody id="player-table-body">
                <!-- rows get injected here -->
            </tbody>
            <tfoot>
                <tr class="th-bg-primary text-center">
                    <th colspan="1" class="sticky-col round-border-lg-btm-left"></th>
                    <th colspan="2" class="th-bg-primary round-border-lg-btm-right"></th>
                    <th colspan="15" class="bg-team align-middle round-border-lg-btm">
                        <div id="loading" style="display:none">Loading...</div>
                    </th>
                    <th colspan="11" class="round-border-btm"></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    const positionMap = {
            1: "GK",
            2: "DEF",
            3: "MID",
            4: "FWD"
        };
// --- Top Scorers page config ---
window.tableConfig = {
  table: 'offence',
  url: `/get-sorted-players?table=offence&team_id={{ team_id }}`,
  tbodySelector: '#player-table-body',
  loadingSelector: '#loading',
  currentGw: {{ (current_gw or 1)| int }},
  sortBy: '{{ sort_by }}',
  sortOrder: '{{ order }}',
  columns: [
    // rank + name
    {
        render: (p, idx) => {
            const short = p.web_name.length > 11 ? p.web_name.slice(0, 10) + '…' : p.web_name;
            const badgeUrl = `https://resources.premierleague.com/premierleague/badges/100/t${p.team_code}@x2.png`;

            return `
                    <td class="sticky-col vert-border">
                        <div class="d-flex align-items-center">
                            <div class="rank d-none d-lg-block text-center">${idx + 1}</div>
                            <img
                            src="${badgeUrl}"
                            alt="${p.team_name} badge"
                            class="img-fluid overlap-badge ms-1 badge-20"
                            data-bs-toggle="tooltip"
                            title="${p.team_name}"
                            >
                            <div class="d-flex align-items-end ms-1">
                                <div>${short}</div>
                                <div class="small text-muted d-none d-xl-inline">
                                    &nbsp;${positionMap[p.element_type] || p.element_type}
                                </div>
                                <div class="">&nbsp;&nbsp;&nbsp;&nbsp;</div>
                            </div>
                        </div>
                    </td>
                    `;
        }
    },
    { key: "selected_by_percent", className: "sort", dataColumn: "selected_by_percent", formatter: v => `${parseFloat(v).toFixed(0)}%` },
    { key: "now_cost", className: "sort", dataColumn: "now_cost", formatter: v => `£${(v / 10).toFixed(1)}m` },
    // 14 team-specific metrics
    { key: "total_points_team", className: "sort-team vert-border-secondary", sortLevel: "primary", dataColumn: "total_points" },
    { key: 'goals_scored_team', dataColumn: "goals_scored", sortLevel: "primary", className: 'sort-team' },
    { key: 'expected_goals_team', dataColumn: "expected_goals", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_performance_team', dataColumn: "goals_performance", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'expected_goals_per_90_team', dataColumn: "expected_goals_per_90", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_benched_team', className: 'sort-team text-danger' },
    { key: 'goals_captained_team', className: 'sort-team' },
    { key: 'assists_team', dataColumn: "assists", sortLevel: "primary", className: 'sort-team vert-border' },
    { key: 'expected_assists_team', dataColumn: "expected_assists", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'assists_performance_team', dataColumn: "assists_performance", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'assists_benched_team', className: 'sort-team text-danger' },
    { key: 'assists_captained_team', className: 'sort-team' },
    { key: 'goals_assists_team', dataColumn: "goals_assists", sortLevel: "primary", className: 'sort-team vert-border' },
    { key: 'expected_goal_involvements_team', dataColumn: "expected_goal_involvements", sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_assists_performance_team', dataColumn: "goals_assists_performance", sortLevel: "primary", className: 'sort-team vert-border-secondary-end', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    // { key: 'goals_assists_performance_team_vs_total', sortLevel: "primary", className: 'sort-team', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    
    // 9 overall metrics
    { key: "total_points", className: "sort vert-border", sortLevel: "secondary", dataColumn: "total_points" },
    { key: 'goals_scored', dataColumn: "goals_scored", sortLevel: "secondary", className: 'sort vert-border' },
    { key: 'expected_goals', dataColumn: "expected_goals", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_performance', dataColumn: "goals_performance", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'expected_goals_per_90', dataColumn: "expected_goals_per_90", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'assists', dataColumn: "assists", sortLevel: "secondary", className: 'sort vert-border' },
    { key: 'expected_assists', dataColumn: "expected_assists", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'assists_performance', dataColumn: "assists_performance", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_assists', dataColumn: "goals_assists", sortLevel: "secondary", className: 'sort vert-border' },
    { key: 'expected_goal_involvements', dataColumn: "expected_goal_involvements", sortLevel: "secondary", className: 'sort', formatter: v => (Math.round(v*10)/10).toFixed(1) },
    { key: 'goals_assists_performance', dataColumn: "goals_assists_performance", sortLevel: "secondary", className: 'sort vert-border-end', formatter: v => (Math.round(v*10)/10).toFixed(1) }
  ]
};

// ── page-specific human‐readable lookup for tooltips & sort-info ──
; (function () {
    const name = {{ manager.team_name| tojson
}};
window.tableConfig.lookup = {
    "selected_by_percent": "Teams selected by",
    "now_cost": "Current price",
    "total_points": "Total points",
    "total_points_team": `Total points for ${name}`,
    "goals_scored_team": `Goals scored for ${name}`,
    "expected_goals_team": `Expected goals for ${name}`,
    "goals_performance_team": `Goals scored vs expected goals scored for ${name}`,
    "goals_benched_team": `Benched goals for ${name}`,
    "goals_captained_team": `Captain goals for ${name}`,
    "assists_team": `Assists for ${name}`,
    "expected_assists_team": `Expected assists for ${name}`,
    "expected_goals_per_90_team": `Expected goals per 90 for ${name}`,
    "assists_performance_team": `Assists vs expected assists for ${name}`,
    "assists_benched_team": `Benched assists for ${name}`,
    "assists_captained_team": `Captain assists for ${name}`,
    "goals_assists_team": `Goal Involvements for ${name} (Goals + Assists)`,
    "expected_goal_involvements_team": `Expected goals + expected assists for ${name}`,
    "goals_assists_performance_team": `G+A vs xG+xA for ${name}`,
    "goals_assists_performance_team_vs_total":
        `G+A vs xG+xA vs total for ${name}`,
    "goals_scored": `Total goals scored`,
    "expected_goals": `Total expected goals`,
    "goals_performance": `Goals scored vs expected goals`,
    "assists": `Total assists`,
    "expected_assists": `Expected assists`,
    "assists_performnce": `Assists vs expected assists`,
    "expected_goals_per_90": `Expected goals per 90`,
    "goals_assists": `Total goals + assists`,
    "expected_goal_involvements": `Total xG+xA`,
    "goals_assists_performance": `G+A vs xG+xA`,
    "top-players": `Top player pictures`,
    "entries": `Number of players`,
    "team-data": `Team stats`,
    "overall-data": `Overall stats`
};
}) ();


(() => {
    const wraps = document.querySelectorAll('.table-scroll-viewport.sticky-2rows');
    wraps.forEach(wrap => {
        const row1 = wrap.querySelector('thead tr:first-child');
        if (!row1) return;
        const setTop = () => wrap.style.setProperty('--th-row1-h', (row1.getBoundingClientRect().height || 0) + 'px');
        setTop();
        addEventListener('resize', setTop, { passive: true });
        if ('ResizeObserver' in window) new ResizeObserver(setTop).observe(row1);
    });
})();
</script>


{% endblock %}
